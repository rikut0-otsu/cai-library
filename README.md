# CAI LIBRARY マニュアル（統合版）

本ドキュメントは、**CAI LIBRARY の利用者・管理者・運用担当・開発者**が共通で参照できる統合マニュアルです。  
「目次だけ」ではなく、現時点の実装に沿った機能説明・運用手順・開発情報までをまとめています。

---

## 目次

1. [はじめに](#1-はじめに)  
2. [プロダクト概要](#2-プロダクト概要)  
3. [利用開始ガイド（ユーザー向け）](#3-利用開始ガイドユーザー向け)  
4. [機能詳細マニュアル](#4-機能詳細マニュアル)  
5. [管理者マニュアル](#5-管理者マニュアル)  
6. [運用マニュアル](#6-運用マニュアル)  
7. [開発者向けドキュメント](#7-開発者向けドキュメント)  
8. [セキュリティ・権限モデル](#8-セキュリティ権限モデル)  
9. [FAQ / トラブルシューティング](#9-faq--トラブルシューティング)  
10. [変更履歴運用（テンプレート）](#10-変更履歴運用テンプレート)  
11. [付録](#11-付録)  

---

## 1. はじめに

### 1.1 本ドキュメントの目的
- CAI LIBRARY の仕様理解を促進する
- 利用者／管理者／運用担当／開発者間で用語と操作認識を揃える
- 新規参加者のオンボーディングを短縮する

### 1.2 想定読者
- **一般ユーザー**: 事例の閲覧、投稿、お気に入り、問い合わせ
- **管理者**: 招待コード管理、ユーザー管理、問い合わせ管理、ダッシュボード確認
- **オーナー**: 管理者権限に加えて一部の強権操作（固定表示、問い合わせ削除など）
- **開発者**: React + tRPC + Drizzle の拡張/保守

### 1.3 用語（主要）
- **事例（Case Study）**: AI活用の実践例。カテゴリ、課題、解決策、手順、効果を持つ
- **お気に入り（Favorite）**: ユーザーごとの事例ブックマーク
- **招待コード**: 許可ドメイン外メールでログインする際の追加認証情報
- **オーナー**: `OWNER_OPEN_ID` に一致する最上位運用ユーザー

---

## 2. プロダクト概要

### 2.1 コンセプト
CAI LIBRARY は、AI活用事例をチームで蓄積・検索・共有するナレッジ基盤です。  
「投稿 → 閲覧 → お気に入り → 再利用」を繰り返し、組織内のAI活用を底上げします。

### 2.2 主な提供機能
- Google OAuth ログイン
- 事例一覧/詳細閲覧
- 事例の新規作成・編集・削除
- AIによるタグ自動生成
- お気に入り管理
- 共有導線（URLベース）
- 問い合わせ投稿
- 管理者ページ（招待コード、ユーザー管理、問い合わせ管理、統計）
- AI相談ページ（外部チャットボット iframe 連携）

### 2.3 画面構成
- `/login`: ログイン画面
- `/`: ホーム（事例一覧）
- `/profile`: プロフィール
- `/admin`: 管理者ページ
- `/ai-consult`: AI相談画面

---

## 3. 利用開始ガイド（ユーザー向け）

### 3.1 ログイン
1. `/login` にアクセス
2. 「Googleでログイン」または「アカウントを選んでログイン」をクリック
3. 許可ドメイン外メールの場合、必要に応じて招待コードを入力

### 3.2 初回利用時に確認すること
- 表示名、部署・職種、プロフィール画像を `プロフィール` で更新
- ホーム画面のカテゴリ/検索/並び替えを確認
- 投稿を行う場合は Google ログインであることを確認

### 3.3 基本操作
- 気になる事例は「お気に入り」へ登録
- 事例カードを開いて詳細を閲覧
- 自分の事例は編集/削除可能（管理者は他者事例削除も可）

---

## 4. 機能詳細マニュアル

### 4.1 事例管理

#### 4.1.1 一覧表示
- すべての事例を閲覧可能（未ログインでも公開範囲で閲覧）
- ログイン時は自分のお気に入り状態が反映
- オーナーが固定表示した事例は常に上位表示

#### 4.1.2 検索・絞り込み・並び替え
- キーワード検索（タイトル/説明）
- カテゴリ（ALL / お気に入り / プロンプト集 / 自動化 / ツール活用 / 活性化施策）
- 並び替え（既定、作成日順、更新日順）

#### 4.1.3 新規投稿
- Googleログインユーザーのみ投稿可能
- 入力項目: タイトル、説明、カテゴリ、使用ツール、課題、解決策、手順、効果、サムネイル
- 投稿時にAIタグが自動生成される（失敗時はカテゴリ＋ツール由来のフォールバック）

#### 4.1.4 編集
- 投稿者本人のみ編集可能
- 編集時もタグは再生成

#### 4.1.5 削除
- 投稿者本人、または管理者が削除可能
- 固定表示中の事例が削除された場合、固定設定は解除

### 4.2 お気に入り機能
- ログインユーザーは事例ごとにお気に入りON/OFF可能
- お気に入り一覧取得APIあり（マイページ的な活用が可能）

### 4.3 共有機能
- 事例単位で共有URLを生成し、メッセージ付きで共有可能
- 共有リンク経由で対象事例に誘導

### 4.4 問い合わせ機能
- ログインユーザーがタイトル＋本文で問い合わせ送信
- 送信内容は管理者画面に蓄積
- 管理者が「確認中/完了」の状態管理
- オーナーは問い合わせ削除が可能

### 4.5 AI相談機能
- `/ai-consult` で外部チャットボット（Dify）を iframe 埋め込み
- マイク利用許可を付与（ブラウザ設定に依存）

### 4.6 プロフィール管理
- 表示名、部署・職種、アバター画像を更新
- 画像はストレージAPI経由でアップロード
- 他ユーザーIDを指定したプロフィール参照APIあり

---

## 5. 管理者マニュアル

### 5.1 アクセス条件
- 管理者ロール（`admin`）が必要
- 非管理者は `/admin` アクセス時に403相当の表示

### 5.2 招待コード管理
- 許可ドメイン（`@cyberagent.co.jp`）外ログインの制御用
- 設定値が空の場合、対象外ドメインは実質ログイン不可
- 管理画面で更新・コピー可能

### 5.3 ユーザー管理
- ユーザー検索（名前/メール/openId）
- 並び替え（登録日、最終ログイン、名前順、管理者優先など）
- ロール変更（user/admin）
- ユーザー削除時の2モード
  - 事例を残して削除（事例は実行管理者へ移管）
  - 事例ごと削除

### 5.4 問い合わせ管理
- 確認中・完了タブで切り替え
- チェックボックスで状態変更
- オーナーのみ問い合わせ削除可能

### 5.5 ダッシュボード
- 総ユーザー数
- 総事例数
- 総お気に入り数
- 人気事例（お気に入り数順）

### 5.6 オーナー専用機能
- 事例の「上部固定（pin to top）」
- 問い合わせ削除
- オーナー自身のロール変更・削除は不可（システム保護）

---

## 6. 運用マニュアル

### 6.1 日次運用
- 問い合わせ未対応件数の確認
- 新規投稿の内容確認（不適切投稿や重複確認）
- エラー発生状況のログ確認

### 6.2 週次運用
- 人気事例ランキングの確認
- ユーザー利用傾向（投稿/お気に入り）を把握
- 招待コード運用ルール（期限・配布先）の見直し

### 6.3 月次運用
- アカウント棚卸し（退職者・不要アカウント）
- ガイドライン更新（投稿品質基準、カテゴリ運用）
- 既知課題と改善バックログのメンテナンス

### 6.4 障害時の一次切り分け
1. ログイン不可か、APIエラーか、画面表示崩れかを分類
2. OAuth設定値/DB接続/ストレージ接続/外部LLM接続を確認
3. 影響範囲（全体 or 一部ユーザー）を判定
4. 一時回避策（投稿停止、問い合わせ導線案内等）をアナウンス

---

## 7. 開発者向けドキュメント

### 7.1 技術スタック
- Frontend: React, Vite, Wouter, TanStack Query, Tailwind系UI
- Backend: Express, tRPC
- DB: Cloudflare D1 + Drizzle ORM
- Auth: Google OAuth
- AI連携: Forge API 経由の LLM 呼び出し

### 7.2 主要ディレクトリ
- `client/src/pages`: 画面コンポーネント
- `client/src/components`: UI/機能コンポーネント
- `server/routers.ts`: tRPCルーター定義
- `server/db.ts`: DBアクセス層
- `drizzle/schema.ts`: スキーマ定義
- `server/_core`: 認証・環境変数・LLM・ミドルウェア

### 7.3 セットアップ
```bash
npm install
npm run dev
```

### 7.4 よく使うコマンド
```bash
npm run dev        # 開発起動
npm run check      # TypeScript型チェック
npm run test       # テスト実行（vitest）
npm run build      # 本番ビルド
npm run db:push    # マイグレーション生成＋適用
```

### 7.5 tRPC API（概要）
- `auth`: セッション確認、ログアウト
- `profile`: 自分/他者プロフィール取得、更新、アバターアップロード
- `caseStudies`: 一覧、詳細、作成、更新、削除、お気に入り、固定表示、画像アップロード
- `inquiries`: 問い合わせ投稿
- `admin.*`: メトリクス、招待コード、ユーザー管理、問い合わせ管理

### 7.6 データモデル（概要）
- `users`
- `user_profiles`
- `case_studies`
- `favorites`
- `app_settings`
- `inquiries`

### 7.7 環境変数
- `VITE_APP_ID`
- `JWT_SECRET`
- `DATABASE_URL`
- `OAUTH_SERVER_URL`
- `GOOGLE_CLIENT_SECRET`
- `OWNER_OPEN_ID`
- `BUILT_IN_FORGE_API_URL`
- `BUILT_IN_FORGE_API_KEY`

---

## 8. セキュリティ・権限モデル

### 8.1 認証
- OAuthコールバックでセッショントークンを発行しCookie保存
- `protectedProcedure` でログイン必須APIを保護
- `adminProcedure` で管理者APIを保護

### 8.2 認可（主要ルール）
- 投稿/編集: Googleログインユーザーのみ
- 編集: 投稿者本人のみ
- 削除: 投稿者本人 or 管理者
- ユーザー管理: 管理者のみ
- 強権操作（固定表示/問い合わせ削除等）: オーナーのみ

### 8.3 保護ルール
- オーナーアカウントは削除不可
- オーナーのadmin剥奪不可
- 管理者本人のadmin剥奪不可（自己ロックアウト防止）

---

## 9. FAQ / トラブルシューティング

### Q1. ログイン時に「招待コードが必要です」と表示される
- 許可ドメイン外メールでログインしている可能性があります
- 管理者から有効な招待コードを受領し、ログイン画面で入力してください

### Q2. 投稿ボタンが表示されない / 投稿できない
- Googleログイン以外のアカウントでは投稿不可です

### Q3. 画像アップロードに失敗する
- `BUILT_IN_FORGE_API_URL` / `BUILT_IN_FORGE_API_KEY` 設定を確認
- ストレージサービスの疎通障害有無を確認

### Q4. AIタグが生成されない
- LLM連携失敗時はフォールバックタグを使用します
- 外部APIキーとエンドポイントを確認してください

### Q5. 管理者ページに入れない
- 自分のロールが `admin` か確認
- ログインセッション切れの場合は再ログイン

---

## 10. 変更履歴運用（テンプレート）

以下フォーマットで更新履歴を残す運用を推奨します。

- `YYYY-MM-DD`: 概要 / 影響範囲 / 担当 / 参照PR

例:
- `2026-03-02`: READMEを統合マニュアル化（利用・運用・開発の各章を追加） / 全ユーザー / docs担当 / PR #xxx

---

## 11. 付録

### 11.1 将来的な分冊案
- ユーザーマニュアル（操作中心）
- 管理者・運用マニュアル（権限/手順中心）
- 開発者ガイド（実装/API/デプロイ中心）

### 11.2 推奨追加ドキュメント
- ER図・テーブル定義書
- API仕様書（入力/出力/エラーコード）
- 障害対応Runbook
- セキュリティレビュー記録
